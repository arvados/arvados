#!/bin/bash

exec 2>&1
set -ex -o pipefail

.  /usr/local/lib/arvbox/common.sh

cd /usr/src/arvados/apps/workbench
export RAILS_ENV=development

run_bundler --without=development
bundle exec passenger start --runtime-check-only --runtime-dir=/var/lib/passenger

if test "$1" = "--only-deps" ; then
    exit
fi

set -u

if ! test -s /var/lib/arvados/workbench_secret_token ; then
  ruby -e 'puts rand(2**400).to_s(36)' > /var/lib/arvados/workbench_secret_token
fi
secret_token=$(cat /var/lib/arvados/workbench_secret_token)

if ! test -s self-signed.key ; then
  openssl req -new -x509 -nodes -out self-signed.pem -keyout self-signed.key -days 365 -subj '/CN=localhost'
fi

cat >config/application.yml <<EOF
development:
  secret_token: $secret_token
  arvados_login_base: https://$localip:${services[api]}/login
  arvados_v1_base: https://$localip:${services[api]}/arvados/v1
  arvados_insecure_https: true
  keep_web_download_url: http://$localip:${services[keep-web]}/c=%{uuid_or_pdh}
  keep_web_url: http://$localip:${services[keep-web]}/c=%{uuid_or_pdh}
  arvados_docsite: http://$localip:${services[doc]}/
EOF

(cd config && /usr/local/lib/arvbox/application_yml_override.py)

